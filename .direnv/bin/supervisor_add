#!/usr/bin/env bash

set -ex

DIR=`pwd`


ini=xxai-$1.ini

fp=/etc/supervisor/conf.d/$ini

cp $DIR/supervisor/$ini $fp

rtx="$(which rtx) env"

if [ -x "$(command -v brew)" ]; then
  BIN=$(dirname $(which brew))
fi


sd -s "\$EXE" "bash -c \"export HOME=$HOME && cd $DIR && export PATH=\$PATH:$BIN:$(dirname $(which realpath)) && eval \\\"\$($rtx)\\\" && exec $(which timeout) 1d $(which direnv) exec . $DIR/$2\"" $fp

cd /etc
direnv exec . supervisorctl update
sleep 3
direnv exec . supervisorctl status
